{% extends "base.html" %}

{% block title %}–°–ª–æ—Ç—ã{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="game-container">
                <h2 class="text-center mb-4">üé∞ –°–ª–æ—Ç—ã</h2>

                <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ -->
                <div class="text-center mb-3">
                    <span class="balance me-3">–ë–∞–ª–∞–Ω—Å: <span class="balance-amount">{{ "%.2f"|format(user.balance if user else 0) }}</span>‚ÇΩ</span>
                </div>

                <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
                <div class="slots-machine">
                    <div class="reels-container d-flex justify-content-center gap-3">
                        {% for i in range(3) %}
                        <div class="reel" id="reel-{{ i }}">
                            <div class="reel-strip" style="transition: transform 2s cubic-bezier(0.21, 1, 0.5, 1); will-change: transform;">
                                <!-- –°–∏–º–≤–æ–ª—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è JS -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="control-panel mt-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="bet-amount">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏</label>
                                <input type="number" class="form-control" id="bet-amount" min="1" value="10">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-play w-100" id="spin-button">–ö—Ä—É—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                <div class="results mt-4" id="results" style="display: none;">
                    <div class="win-lines"></div>
                    <div class="win-amount"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.reel {
    width: 90px;
    height: 270px;
    border: 2px solid #ccc;
    border-radius: 10px;
    background: #1a1c2c;
    overflow: hidden;
    position: relative; /* –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª–µ–Ω—Ç—ã */
}
.reel-strip {
    display: flex;
    flex-direction: column;
    position: absolute; /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ª–µ–Ω—Ç—É –∞–±—Å–æ–ª—é—Ç–Ω–æ */
    top: 0; /* –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤–≤–µ—Ä—Ö—É */
    left: 0;
    width: 100%;
}
.symbol {
    font-size: 48px;
    height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}

{% block scripts %}
<script>
const SYMBOLS = ['üçí', 'üçä', 'üçã', 'üçá', '7Ô∏è‚É£', 'üíé'];
const SYMBOL_HEIGHT = 90; // –í—ã—Å–æ—Ç–∞ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
const VISIBLE_SYMBOLS = 3; // –°–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤–∏–¥–Ω–æ –≤ –±–∞—Ä–∞–±–∞–Ω–µ

let isSpinning = false;

function getRandomSymbols(count) {
    const arr = [];
    for (let i = 0; i < count; i++) {
        arr.push(SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]);
    }
    return arr;
}

function createReelStripContent(symbols) {
    return symbols.map(s => `<div class="symbol">${s}</div>`).join('');
}

function spinReel(reelElement, finalSymbols, duration = 3000) {
    const reelStrip = reelElement.querySelector('.reel-strip');
    let currentSymbols = Array.from(reelStrip.querySelectorAll('.symbol')).map(s => s.textContent);

    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞—á–∏–Ω–∞–µ–º —Å 3 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    if (currentSymbols.length !== VISIBLE_SYMBOLS) {
         fillReel(reelStrip, getRandomSymbols(VISIBLE_SYMBOLS));
         currentSymbols = Array.from(reelStrip.querySelectorAll('.symbol')).map(s => s.textContent);
    }

    // –°–æ–∑–¥–∞–µ–º –¥–ª–∏–Ω–Ω—É—é –ª–µ–Ω—Ç—É: —Ç–µ–∫—É—â–∏–µ —Å–∏–º–≤–æ–ª—ã + —Å–ª—É—á–∞–π–Ω—ã–µ + —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ
    const randomCount = 30; // –ë–æ–ª—å—à–µ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    const extendedSymbols = currentSymbols.concat(getRandomSymbols(randomCount), finalSymbols);

    fillReel(reelStrip, extendedSymbols);

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    // –¶–µ–ª—å: –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫ –∏–∑ VISIBLE_SYMBOLS —Å–∏–º–≤–æ–ª–æ–≤ –≤ extendedSymbols –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω –ø–æ —Ü–µ–Ω—Ç—Ä—É.
    // –ò–Ω–¥–µ–∫—Å –ø–µ—Ä–≤–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –∏–∑ finalSymbols –≤ extendedSymbols: currentSymbols.length + randomCount
    // –ò–Ω–¥–µ–∫—Å —Å–∏–º–≤–æ–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ü–µ–Ω—Ç—Ä–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏: currentSymbols.length + randomCount + 1 (–¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ –∏–∑ finalSymbols)
    const targetSymbolIndex = currentSymbols.length + randomCount + 1;
    const targetPosition = -(targetSymbolIndex * SYMBOL_HEIGHT - (VISIBLE_SYMBOLS / 2) * SYMBOL_HEIGHT + SYMBOL_HEIGHT/2); // –°–¥–≤–∏–≥ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è


    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é (—Ç–µ–∫—É—â–∏–µ —Å–∏–º–≤–æ–ª—ã –≤–∏–¥–Ω—ã)
    reelStrip.style.transition = 'none';
    reelStrip.style.transform = `translateY(0px)`;

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –Ω—É–∂–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    setTimeout(() => {
        reelStrip.style.transition = `transform ${duration}ms cubic-bezier(0.21, 1, 0.5, 1)`; // –£–ª—É—á—à–µ–Ω–Ω–∞—è easing —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        reelStrip.style.transform = `translateY(${targetPosition}px)`;
    }, 50); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏

    // –ü–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
    return new Promise(resolve => {
        setTimeout(() => {
            fillReel(reelStrip, finalSymbols);
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –ø–æ —Ü–µ–Ω—Ç—Ä—É
             reelStrip.style.transition = 'none';
             reelStrip.style.transform = `translateY(-${(finalSymbols.length - VISIBLE_SYMBOLS)/2 * SYMBOL_HEIGHT}px)`;

            resolve();
        }, duration + 100);
    });
}

function fillReel(reelStrip, symbols) {
     reelStrip.innerHTML = symbols.map(s => `<div class="symbol">${s}</div>`).join('');
     // –°—Ä–∞–∑—É —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º 3 —Å–∏–º–≤–æ–ª–∞, –µ—Å–ª–∏ –∏—Ö 3
     if (symbols.length === VISIBLE_SYMBOLS) {
         reelStrip.style.transform = `translateY(-${(symbols.length - VISIBLE_SYMBOLS)/2 * SYMBOL_HEIGHT}px)`;
     } else {
        reelStrip.style.transform = 'translateY(0px)';
     }
}


async function spin() {
    if (isSpinning) return;
    isSpinning = true;
    document.getElementById('results').style.display = 'none';
    const reels = Array.from(document.querySelectorAll('.reel'));

    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –±–∞—Ä–∞–±–∞–Ω—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
    reels.forEach(reelElement => {
        const reelStrip = reelElement.querySelector('.reel-strip');
        if (reelStrip.querySelectorAll('.symbol').length === 0) {
             fillReel(reelStrip, getRandomSymbols(VISIBLE_SYMBOLS));
        }
    });

    const betAmount = parseInt(document.getElementById('bet-amount').value);
    if (isNaN(betAmount) || betAmount <= 0) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏');
        isSpinning = false;
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –µ—Å–ª–∏ —Å—Ç–∞–≤–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
         reels.forEach(reelElement => {
            const reelStrip = reelElement.querySelector('.reel-strip');
            fillReel(reelStrip, getRandomSymbols(VISIBLE_SYMBOLS));
        });
        return;
    }

    // –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    const spinPromise = fetch('/play/slots', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bet_amount: betAmount })
    }).then(r => r.json());
    const [data] = await Promise.all([
        spinPromise,
        new Promise(res => setTimeout(res, 1000)) // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏
    ]);

    if (data.error) {
        alert(data.error);
        isSpinning = false;
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ
         reels.forEach(reelElement => {
            const reelStrip = reelElement.querySelector('.reel-strip');
            fillReel(reelStrip, getRandomSymbols(VISIBLE_SYMBOLS));
        });
        return;
    }

    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞—Ä–∞–±–∞–Ω–∞ –±–µ—Ä–µ–º —Ç—Ä–æ–π–∫—É —Å–∏–º–≤–æ–ª–æ–≤ (–≤–µ—Ä—Ö, —Ü–µ–Ω—Ç—Ä, –Ω–∏–∑)
    // data.reels[i] = [top, center, bottom]
    const finalSymbolsArr = data.reels.map(r => Array.isArray(r) && r.length === VISIBLE_SYMBOLS ? r : getRandomSymbols(VISIBLE_SYMBOLS)); // Fallback –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π

    // –í—Ä–∞—â–∞–µ–º –∫–∞–∂–¥—ã–π –±–∞—Ä–∞–±–∞–Ω —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    await Promise.all(reels.map((reelElement, i) =>
        new Promise(res => setTimeout(res, i * 200)).then(() => spinReel(reelElement, finalSymbolsArr[i], 2500 + i * 300)) // –†–∞–∑–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∞ –æ–±—â–∞—è
    ));

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    const results = document.getElementById('results');
    const winLines = results.querySelector('.win-lines');
    const winAmount = results.querySelector('.win-amount');
    results.style.display = 'block';
    if (data.win) {
        winLines.innerHTML = `<div class="alert alert-success">–í—ã–∏–≥—Ä—ã—à–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è!</div>`;
        if (data.winning_lines && data.winning_lines.length > 0) {
            winLines.innerHTML += data.winning_lines.map(line => `<div class="alert alert-info">${line}</div>`).join('');
        }
        winAmount.innerHTML = `<div class="alert alert-success">–û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à: ${data.win_amount}‚ÇΩ</div>`;
    } else {
        winLines.innerHTML = '<div class="alert alert-danger">–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏</div>';
        winAmount.innerHTML = '';
    }
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å, –∏—Å–ø–æ–ª—å–∑—É—è –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ main.js
    updateBalance(data.balance);

    isSpinning = false;

    // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö –ª–∏–Ω–∏–π
    console.log('Winning lines from server:', data.winning_lines);
}
document.getElementById('spin-button').addEventListener('click', spin);
</script>
{% endblock %} 